<ion-header [translucent]="true">
  <ion-toolbar color="light">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Fazer uma reserva</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="wrapper">
    <div class="form-container">
    <!-- Aviso de agendamento ativo (apenas para usu√°rios logados) -->
    <div *ngIf="hasActiveAppointment && authService.isAuthenticated" class="active-appointment-info">
      <ion-icon name="information-circle-outline"></ion-icon>
      <div class="info-content">
        <h3>Voc√™ j√° possui agendamentos ativos</h3>
        <p>Voc√™ pode agendar procedimentos diferentes no mesmo dia, desde que n√£o haja conflito de hor√°rios.</p>
        <div *ngIf="getActiveAppointmentsForToday().length > 0" class="today-appointments">
          <p><strong>Agendamentos de hoje:</strong></p>
          <div *ngFor="let agendamento of getActiveAppointmentsForToday()" class="appointment-item">
            <span>{{ agendamento.procedimento_nome }} - {{ agendamento.hora }}</span>
          </div>
        </div>
        <ion-button fill="outline" size="small" (click)="navigateToMeusAgendamentos()">
          Ver todos os agendamentos
        </ion-button>
      </div>
    </div>

    <!-- Coluna Esquerda - Formul√°rio Principal -->
    <div class="form-section">
      <h3>Informa√ß√µes do Agendamento</h3>

      <!-- Mensagem especial para profissionais -->
      <div *ngIf="authService.isAuthenticated && authService.currentUser?.role === 'profissional'" class="professional-notice">
        <ion-icon name="information-circle-outline"></ion-icon>
        <div class="notice-content">
          <h4>Agendamento para Profissional</h4>
          <p>Voc√™ est√° agendando um procedimento para voc√™ mesmo. Selecione "Sem prefer√™ncia" para agendamento autom√°tico ou escolha outro profissional.</p>
        </div>
      </div>

      <ion-list lines="none" class="card">
        <!-- Procedimento -->
        <div class="procedimento-section">
          <ion-label class="section-label">Escolha o Procedimento</ion-label>
          <div class="procedimentos-grid">
            <!-- C√≠lios -->
            <div
              class="procedimento-card"
              [class.selected]="selectedProcedimento === ciliosProcedimentoId"
              (click)="setProcedimento(ciliosProcedimentoId)">
              <div class="procedimento-icon">
                <ion-icon name="eye-outline"></ion-icon>
              </div>
              <span class="procedimento-label">C√≠lios</span>
            </div>

            <!-- L√°bios -->
            <div
              class="procedimento-card"
              [class.selected]="selectedProcedimento === labiosProcedimentoId"
              (click)="setProcedimento(labiosProcedimentoId)">
              <div class="procedimento-icon">
                <ion-icon name="eyedrop-outline"></ion-icon>
              </div>
              <span class="procedimento-label">L√°bios</span>
            </div>

            <!-- Combo -->
            <div
              class="procedimento-card combo-card"
              [class.selected]="selectedProcedimento === comboProcedimentoId"
              (click)="setProcedimento(comboProcedimentoId)">
              <div class="procedimento-icon combo-icon">
                <div class="combo-left">
                  <ion-icon name="eye-outline"></ion-icon>
                </div>
                <div class="combo-right">
                  <ion-icon name="eyedrop-outline"></ion-icon>
                </div>
              </div>
              <span class="procedimento-label">Combo</span>
            </div>
          </div>
        </div>

      <!-- Profissional -->
      <div class="profissional-section">
        <ion-label class="section-label">Escolha o Profissional</ion-label>
        <div class="profissionais-grid">
          <!-- Op√ß√£o "Sem prefer√™ncia" -->
          <div
            class="profissional-card"
            [class.selected]="selectedProfissional === 0"
            (click)="selectProfissional(0)">
            <div class="profissional-avatar">
              <ion-icon name="person-outline"></ion-icon>
            </div>
            <span class="profissional-name">Sem prefer√™ncia</span>
          </div>

          <!-- Profissionais -->
          <div
            *ngFor="let prof of profissionais"
            class="profissional-card"
            [class.selected]="selectedProfissional === prof.id"
            (click)="selectProfissional(prof.id)">
            <div class="profissional-avatar">
              <img *ngIf="prof.foto" [src]="prof.foto" [alt]="prof.nome">
              <ion-icon *ngIf="!prof.foto" name="person-outline"></ion-icon>
            </div>
            <span class="profissional-name">{{ prof.nome }}</span>
          </div>
        </div>
      </div>



      <!-- Data -->
      <div class="calendar-container">
        <ion-datetime
          presentation="date"
          locale="pt-BR"
          [(ngModel)]="selectedDate"
          (ionChange)="onDateChange()"
          [min]="minDate"
          class="calendar"
          color="primary"
        ></ion-datetime>
      </div>

      <!-- Filtro de Per√≠odos -->
      <div class="period-filter" *ngIf="horariosDisponiveis.length > 0">
        <ion-segment [(ngModel)]="selectedPeriod" (ionChange)="onPeriodChange()">
          <ion-segment-button value="morning">
            <ion-label>Manh√£</ion-label>
          </ion-segment-button>
          <ion-segment-button value="afternoon">
            <ion-label>Tarde</ion-label>
          </ion-segment-button>
          <ion-segment-button value="evening">
            <ion-label>Noite</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>

      <!-- Hor√°rios -->
      <div class="time-slots-container">
        <div class="time-slots" *ngIf="horariosDisponiveisFiltrados.length > 0">
          <ion-chip
            *ngFor="let t of horariosDisponiveisFiltrados"
            (click)="selectedTime = t"
            [class.active]="selectedTime === t">
            {{ t }}
          </ion-chip>
        </div>

        <!-- Mensagem quando n√£o h√° hor√°rios -->
        <div *ngIf="horariosDisponiveisFiltrados.length === 0 && selectedDate" class="no-schedule-message">
          <ion-icon name="calendar-outline"></ion-icon>
          <p>Sem hor√°rios dispon√≠veis para este per√≠odo</p>
          <small>Escolha outro per√≠odo ou entre em contato conosco</small>
        </div>

        <!-- Sugest√µes inteligentes -->
        <div *ngIf="sugestoes.length > 0" class="suggestions-container">
          <h4>üí° Sugest√µes</h4>

          <!-- Sugest√£o de pr√≥xima data -->
          <div *ngFor="let sugestao of sugestoes" class="suggestion-card">
            <div *ngIf="sugestao.tipo === 'proxima_data'" class="suggestion-item proxima-data">
              <ion-icon name="calendar-outline"></ion-icon>
              <div class="suggestion-content">
                <h5>Pr√≥xima data dispon√≠vel</h5>
                <p>{{ sugestao.mensagem }}</p>
                <ion-button
                  fill="outline"
                  size="small"
                  (click)="onSugestaoProximaData(sugestao)">
                  Ver hor√°rios
                </ion-button>
              </div>
            </div>

            <!-- Sugest√£o de outro profissional -->
            <div *ngIf="sugestao.tipo === 'outro_profissional'" class="suggestion-item outro-profissional">
              <ion-icon name="person-outline"></ion-icon>
              <div class="suggestion-content">
                <h5>Outro profissional dispon√≠vel</h5>
                <p>{{ sugestao.mensagem }}</p>
                <ion-button
                  fill="outline"
                  size="small"
                  (click)="onSugestaoOutroProfissional(sugestao)">
                  Escolher profissional
                </ion-button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Op√ß√µes por procedimento -->
      <ng-container *ngIf="isCiliosSelected">
        <!-- Tipos de c√≠lios (se dispon√≠vel) -->
        <ng-container *ngIf="getCiliosTypeOptions().length > 0">
          <ion-label class="section-label">Tipo de c√≠lios</ion-label>
          <div class="options-grid">
            <div
              *ngFor="let opt of getCiliosTypeOptions()"
              class="option-item">
              <div
                class="option-card"
                [class.selected]="tipoCilios === opt.value"
                (click)="updateTipoCilios(opt.value)">
                <div class="option-icon">
                  <ion-icon name="eye-outline"></ion-icon>
                </div>
              </div>
              <span
                class="option-label-text"
                [class.selected]="tipoCilios === opt.value">
                {{ opt.label }}
              </span>
            </div>
          </div>
        </ng-container>

        <!-- Cores de c√≠lios (se dispon√≠vel) -->
        <ng-container *ngIf="getCiliosCorOptions().length > 0">
          <ion-label class="section-label">Cor dos c√≠lios</ion-label>
          <div class="options-grid">
            <div
              *ngFor="let c of getCiliosCorOptions()"
              class="option-item">
              <div
                class="option-card color-option"
                [class.selected]="corCilios === c.value"
                (click)="updateCorCilios(c.value)">
                <div class="option-icon">
                  <div class="color-dot" [style.background]="c.value === 'preto' ? '#000000' : '#8B4513'"></div>
                </div>
              </div>
              <span
                class="option-label-text"
                [class.selected]="corCilios === c.value">
                {{ c.label }}
              </span>
            </div>
          </div>
        </ng-container>
      </ng-container>

      <!-- Op√ß√µes para l√°bios individuais -->
      <ng-container *ngIf="isLabiosSelected && !isComboSelected">
        <ng-container *ngIf="getLabiosCorOptions().length > 0">
          <ion-label class="section-label">Cor dos l√°bios</ion-label>
          <div class="options-grid">
            <div
              *ngFor="let c of getLabiosCorOptions()"
              class="option-item">
              <div
                class="option-card color-option"
                [class.selected]="corLabios === c.value"
                (click)="updateCorLabios(c.value)">
                <div class="option-icon">
                  <div class="color-dot" [style.background]="getCorBackground(c)"></div>
                </div>
              </div>
              <span
                class="option-label-text"
                [class.selected]="corLabios === c.value">
                {{ c.label }}
              </span>
            </div>
          </div>
        </ng-container>
      </ng-container>

      <!-- Combo: C√≠lios + L√°bios -->
      <ng-container *ngIf="isComboSelected && procedimentos && procedimentos.length > 0">
        <div class="combo-section">
          <h3>Op√ß√µes de Combo</h3>

          <!-- Tipo de c√≠lios para combo -->
          <ng-container *ngIf="comboCiliosTypeOptions && comboCiliosTypeOptions.length > 0">
            <ion-label class="section-label">Tipo de c√≠lios</ion-label>
            <div class="options-grid">
              <div
                *ngFor="let opt of comboCiliosTypeOptions; trackBy: trackByOptionId"
                class="option-item">
                <div
                  class="option-card"
                  [class.selected]="tipoCilios === opt.value"
                  (click)="updateTipoCilios(opt.value)">
                  <div class="option-icon">
                    <ion-icon name="eye-outline"></ion-icon>
                  </div>
                </div>
                <span
                  class="option-label-text"
                  [class.selected]="tipoCilios === opt.value">
                  {{ opt.label }}
                </span>
              </div>
            </div>
          </ng-container>

          <!-- Cor dos c√≠lios para combo -->
          <ng-container *ngIf="comboCiliosCorOptions && comboCiliosCorOptions.length > 0">
            <ion-label class="section-label">Cor dos c√≠lios</ion-label>
            <div class="options-grid">
              <div
                *ngFor="let c of comboCiliosCorOptions; trackBy: trackByOptionId"
                class="option-item">
                <div
                  class="option-card color-option"
                  [class.selected]="corCilios === c.value"
                  (click)="updateCorCilios(c.value)">
                  <div class="option-icon">
                    <div class="color-dot" [style.background]="c.value === 'preto' ? '#000000' : '#8B4513'"></div>
                  </div>
                </div>
                <span
                  class="option-label-text"
                  [class.selected]="corCilios === c.value">
                  {{ c.label }}
                </span>
              </div>
            </div>
          </ng-container>

          <!-- Cor dos l√°bios para combo -->
          <ng-container *ngIf="comboLabiosCorOptions && comboLabiosCorOptions.length > 0">
            <ion-label class="section-label">Cor dos l√°bios</ion-label>
            <div class="options-grid">
              <div
                *ngFor="let c of comboLabiosCorOptions; trackBy: trackByOptionId"
                class="option-item">
                <div
                  class="option-card color-option"
                  [class.selected]="corLabios === c.value"
                  (click)="updateCorLabios(c.value)">
                  <div class="option-icon">
                    <div class="color-dot" [style.background]="getCorBackground(c)"></div>
                  </div>
                </div>
                <span
                  class="option-label-text"
                  [class.selected]="corLabios === c.value">
                  {{ c.label }}
                </span>
              </div>
            </div>
          </ng-container>
        </div>
      </ng-container>

      </ion-list>
    </div>

    <!-- Coluna Direita - Resumo e Pre√ßo -->
    <div class="form-section summary-footer">
      <div class="summary-content">
        <div class="price-info">
          <h3>Valor Total</h3>
          <div class="price-value">R$ {{ (currentPrice / 100).toFixed(2) }}</div>
          <div class="duration-info">{{ currentDuration }} minutos</div>
        </div>

        <ion-button class="submit-button" (click)="onSubmit()">
          Continuar
        </ion-button>
      </div>
    </div>
    <!-- Removido fechamento duplicado de </div> -->
