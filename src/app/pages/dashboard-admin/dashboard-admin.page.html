<ion-header [translucent]="true">
  <ion-toolbar class="custom-toolbar">
    <ion-title class="toolbar-title">
      <div class="title-content">
        <ion-icon name="calendar-outline" class="title-icon"></ion-icon>
        <span>Gest√£o da Agenda</span>
      </div>
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="dashboard-content">
  <div class="admin-container">
    <!-- Header Section -->
    <div class="dashboard-header">
      <div class="header-content">
        <h1 class="dashboard-title">Painel de Controle</h1>
        <p class="dashboard-subtitle">Gerencie hor√°rios e agendamentos de forma eficiente</p>
      </div>
      <div class="header-stats">
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-info">
            <span class="stat-number">{{ profissionais.length }}</span>
            <span class="stat-label">Profissionais</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-info">
            <span class="stat-number">{{ agendamentosData.length }}</span>
            <span class="stat-label">Agendamentos</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Seletor de Data e Configura√ß√µes -->
    <div class="controls-section">
      <ion-card class="date-card">
        <ion-card-header>
          <ion-card-title class="card-title">
            <ion-icon name="calendar-outline"></ion-icon>
            Configura√ß√µes da Agenda
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="date-selector">
            <ion-item class="custom-item">
              <ion-label position="stacked" class="custom-label">üìÖ Selecionar Data</ion-label>
              <ion-input
                type="date"
                [(ngModel)]="selectedDate"
                (ionInput)="onDateChange()"
                class="custom-input">
              </ion-input>
            </ion-item>
          </div>

          <!-- Se√ß√£o de Libera√ß√£o R√°pida -->
          <div class="quick-actions">
            <h4 class="section-title">
              <ion-icon name="flash-outline"></ion-icon>
              A√ß√µes R√°pidas
            </h4>
            <div class="action-buttons">
              <ion-button
                class="action-btn success-btn"
                (click)="liberarTodosHorarios()"
                [disabled]="loadingAgendamentos || liberarTodosConfirmando">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                <span *ngIf="!liberarTodosConfirmando">Liberar Todos</span>
                <span *ngIf="liberarTodosConfirmando">Processando...</span>
              </ion-button>
              <ion-button
                class="action-btn danger-btn"
                (click)="bloquearTodosHorarios()"
                [disabled]="loadingAgendamentos || bloquearTodosConfirmando">
                <ion-icon name="close-circle-outline"></ion-icon>
                <span *ngIf="!bloquearTodosConfirmando">Bloquear Todos</span>
                <span *ngIf="bloquearTodosConfirmando">Processando...</span>
              </ion-button>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Se√ß√£o de Filtros -->
      <ion-card class="filters-card">
        <ion-card-header>
          <ion-card-title class="card-title">
            <ion-icon name="filter-outline"></ion-icon>
            Filtros e Configura√ß√µes
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <!-- Sele√ß√£o de Profissional -->
          <div class="filter-section">
            <ion-label class="section-label">
              <ion-icon name="person-outline"></ion-icon>
              Escolha o Profissional
            </ion-label>
            <div class="profissionais-grid">
              <!-- Op√ß√£o "Todos" -->
              <div
                class="profissional-card"
                [class.selected]="selectedProfissional === '0'"
                (click)="selectProfissional('0')">
                <div class="profissional-avatar">
                  <ion-icon name="people-outline"></ion-icon>
                </div>
                <span class="profissional-name">Todos</span>
              </div>

              <!-- Profissionais -->
              <div
                *ngFor="let prof of profissionais"
                class="profissional-card"
                [class.selected]="selectedProfissional === prof.id.toString()"
                (click)="selectProfissional(prof.id.toString())">
                <div class="profissional-avatar">
                  <img *ngIf="prof.foto" [src]="prof.foto" [alt]="prof.nome">
                  <ion-icon *ngIf="!prof.foto" name="person-outline"></ion-icon>
                </div>
                <span class="profissional-name">{{ prof.nome }}</span>
              </div>

              <div *ngIf="loadingProfissionais" class="loading-indicator">
                <ion-spinner name="crescent"></ion-spinner>
                <span>Carregando profissionais...</span>
              </div>
            </div>
          </div>

          <!-- Sele√ß√£o de Procedimento -->
          <div class="filter-section">
            <ion-label class="section-label">
              <ion-icon name="medical-outline"></ion-icon>
              Escolha o Procedimento
            </ion-label>
            <div class="procedimentos-grid">
              <!-- Op√ß√£o "Todos" -->
              <div
                class="procedimento-card"
                [class.selected]="selectedProcedimento === '0'"
                (click)="selectProcedimento('0')">
                <div class="procedimento-icon">
                  <ion-icon name="grid-outline"></ion-icon>
                </div>
                <span class="procedimento-label">Todos</span>
              </div>

              <!-- Procedimentos filtrados -->
              <div
                *ngFor="let procedimento of procedimentosFiltrados"
                class="procedimento-card"
                [class.selected]="selectedProcedimento === procedimento.id.toString()"
                (click)="selectProcedimento(procedimento.id.toString())">
                <div class="procedimento-icon">
                  <ion-icon [name]="getProcedimentoIcon(procedimento.categoria)"></ion-icon>
                </div>
                <span class="procedimento-label">{{ procedimento.nome }}</span>
              </div>

              <div *ngIf="loadingProcedimentos" class="loading-indicator">
                <ion-spinner name="crescent"></ion-spinner>
                <span>Carregando procedimentos...</span>
              </div>
            </div>
          </div>

          <!-- Indicador de filtro ativo -->
          <div *ngIf="selectedProfissional !== '0' && procedimentosFiltrados.length < procedimentos.length" class="filter-indicator">
            <small>üìã Mostrando apenas procedimentos que {{ getProfissionalNome() }} pode realizar</small>
          </div>

          <div class="time-range">
            <div class="time-inputs">
              <ion-item class="custom-item">
                <ion-label position="stacked" class="custom-label">
                  <ion-icon name="time-outline"></ion-icon>
                  Hor√°rio Inicial
                </ion-label>
                <ion-input
                  type="time"
                  [(ngModel)]="horarioInicial"
                  placeholder="08:00"
                  class="custom-input">
                </ion-input>
              </ion-item>

              <ion-item class="custom-item">
                <ion-label position="stacked" class="custom-label">
                  <ion-icon name="time-outline"></ion-icon>
                  Hor√°rio Final
                </ion-label>
                <ion-input
                  type="time"
                  [(ngModel)]="horarioFinal"
                  placeholder="18:00"
                  class="custom-input">
                </ion-input>
              </ion-item>
            </div>

            <div class="specific-action-buttons">
              <ion-button
                class="specific-action-btn success-btn"
                expand="block"
                (click)="liberarHorariosEspecificos()">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                Liberar Hor√°rios Espec√≠ficos
              </ion-button>
              <ion-button
                class="specific-action-btn warning-btn"
                expand="block"
                (click)="liberarSemanaEspecifica()">
                <ion-icon name="calendar-outline"></ion-icon>
                Liberar Semana (Profissional + Procedimento)
              </ion-button>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Indicador de altera√ß√µes pendentes -->
      <ion-card *ngIf="hasUnsavedChanges" class="pending-changes-card">
        <ion-card-content>
          <div class="pending-changes">
            <div class="pending-info">
              <ion-icon name="warning-outline" class="warning-icon"></ion-icon>
              <div class="pending-text">
                <h4>{{ pendingChanges.length }} altera√ß√£o(√µes) pendente(s)</h4>
                <p>Salve as altera√ß√µes para aplic√°-las √† agenda</p>
              </div>
            </div>
            <div class="save-actions">
              <ion-button
                class="save-btn"
                expand="block"
                (click)="salvarAlteracoes()">
                <ion-icon name="save-outline"></ion-icon>
                Salvar Altera√ß√µes
              </ion-button>
              <ion-button
                class="discard-btn"
                expand="block"
                fill="outline"
                (click)="descartarAlteracoes()">
                <ion-icon name="close-outline"></ion-icon>
                Descartar
              </ion-button>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

    <!-- Grade de Hor√°rios -->
    <ion-card class="schedule-card">
      <ion-card-header>
        <ion-card-title class="card-title">
          <ion-icon name="grid-outline"></ion-icon>
          Agenda - {{ formatDate(selectedDate) }}
        </ion-card-title>
               <div class="schedule-info">
                 <p class="schedule-description">Clique nos hor√°rios para liberar/bloquear</p>
                 <div *ngIf="selectedProfissional !== '0' || selectedProcedimento !== '0'" class="professional-filter-indicator">
                   <ion-icon name="person-outline"></ion-icon>
                   <span *ngIf="selectedProfissional !== '0'"><strong>{{ getProfissionalNome() }}</strong></span>
                   <span *ngIf="selectedProfissional !== '0' && selectedProcedimento !== '0'"> ‚Ä¢ </span>
                   <span *ngIf="selectedProcedimento !== '0'"><strong>{{ getProcedimentoCategoria() }}</strong></span>
                 </div>
                 <div *ngIf="selectedProcedimento !== '0'" class="procedimento-info">
                   <ion-icon name="time-outline"></ion-icon>
                   <span>Dura√ß√£o: {{ getProcedimentoDuracao(selectedProcedimento) }} minutos</span>
                 </div>
               </div>
        <div class="schedule-stats">
          <div class="stat-item">
            <span class="stat-number">{{ getAvailableSlots() }}</span>
            <span class="stat-label">Dispon√≠veis</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ getBookedSlots() }}</span>
            <span class="stat-label">Agendados</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ getBlockedSlots() }}</span>
            <span class="stat-label">Bloqueados</span>
          </div>
        </div>
      </ion-card-header>
      <ion-card-content>
        <!-- Loading state -->
        <div *ngIf="loadingAgendamentos" class="loading-container">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Carregando hor√°rios...</p>
        </div>

        <!-- Time grid -->
        <div *ngIf="!loadingAgendamentos" class="time-grid">
          <div *ngFor="let slot of timeSlots"
               class="time-slot"
               [class.available]="slot.status === 'livre'"
               [class.blocked]="slot.status === 'bloqueado'"
               [class.booked]="slot.status === 'ocupado'"
               [class.has-changes]="slot.hasChanges"
               [class.almoco]="isHorarioAlmoco(slot.time)"
               (click)="toggleTimeSlot(slot)">
            <div class="time">{{ slot.time }}</div>
            <div class="status">{{ getStatusLabel(slot.status) }}</div>
            <div *ngIf="slot.cliente" class="client">{{ slot.cliente }}</div>
            <div *ngIf="slot.hasChanges" class="change-indicator">‚úèÔ∏è</div>
          </div>
        </div>

        <div class="legend">
          <div class="legend-item">
            <span class="legend-dot available"></span>
            <span>Livre</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot blocked"></span>
            <span>Bloqueado</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot booked"></span>
            <span>Ocupado</span>
          </div>
          <div class="legend-item" *ngIf="selectedProfissional !== '0'">
            <span class="legend-dot almoco"></span>
            <span>Almo√ßo üçΩÔ∏è</span>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Agendamentos do Dia -->
    <ion-card *ngIf="agendamentosData.length > 0">
      <ion-card-header>
        <ion-card-title>Agendamentos de {{ selectedDate }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let ag of agendamentosData">
            <ion-label>
              <h3>{{ ag.hora }} - {{ ag.cliente_nome || 'Cliente' }}</h3>
              <p>{{ ag.procedimento_nome || 'Procedimento' }}</p>
              <p class="status-badge" [class]="'status-' + ag.status">{{ ag.status | titlecase }}</p>
              <p *ngIf="ag.observacoes"><small>{{ ag.observacoes }}</small></p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
    <!-- Removido fechamento duplicado de </ion-content> -->
