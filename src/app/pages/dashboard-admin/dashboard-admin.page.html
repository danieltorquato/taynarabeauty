<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Gest√£o da Agenda</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="admin-container">

    <!-- Seletor de Data e Configura√ß√µes -->
    <ion-card class="date-card">
      <ion-card-content>
        <ion-item>
          <ion-label position="stacked">Selecionar Data</ion-label>
          <ion-input type="date" [(ngModel)]="selectedDate" (ionInput)="onDateChange()"></ion-input>
        </ion-item>

        <!-- Se√ß√£o de Libera√ß√£o R√°pida -->
        <div class="quick-actions">
          <h4>Libera√ß√£o R√°pida</h4>
          <div class="action-buttons">
            <ion-button size="small" (click)="liberarTodosHorarios()">
              üìÖ Liberar Todos
            </ion-button>
            <ion-button size="small" color="danger" (click)="bloquearTodosHorarios()">
              üö´ Bloquear Todos
            </ion-button>
          </div>
        </div>

        <!-- Se√ß√£o de Libera√ß√£o Espec√≠fica -->
        <div class="specific-actions">
          <h4>Libera√ß√£o Espec√≠fica</h4>

          <ion-item>
            <ion-label position="stacked">Profissional</ion-label>
            <ion-select [(ngModel)]="selectedProfissional" (ionChange)="onProfissionalChange()" placeholder="Selecionar profissional">
              <ion-select-option value="0">Todos os profissionais</ion-select-option>
              <ion-select-option *ngFor="let prof of profissionais" [value]="prof.id">
                {{ prof.nome }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Procedimento</ion-label>
            <ion-select [(ngModel)]="selectedProcedimento" placeholder="Selecionar procedimento">
              <ion-select-option value="0">Todos os procedimentos</ion-select-option>
              <ion-select-option *ngFor="let proc of procedimentosFiltrados" [value]="proc.id">
                {{ proc.nome }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Indicador de filtro ativo -->
          <div *ngIf="selectedProfissional !== '0' && procedimentosFiltrados.length < procedimentos.length" class="filter-indicator">
            <small>üìã Mostrando apenas procedimentos que {{ getProfissionalNome() }} pode realizar</small>
          </div>

          <ion-item>
            <ion-label position="stacked">Hor√°rio Inicial</ion-label>
            <ion-input type="time" [(ngModel)]="horarioInicial" placeholder="08:00"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Hor√°rio Final</ion-label>
            <ion-input type="time" [(ngModel)]="horarioFinal" placeholder="18:00"></ion-input>
          </ion-item>

          <div class="specific-action-buttons">
            <ion-button expand="block" color="success" (click)="liberarHorariosEspecificos()">
              ‚úÖ Liberar Hor√°rios Espec√≠ficos
            </ion-button>
            <ion-button expand="block" color="warning" (click)="liberarSemanaEspecifica()">
              üìÜ Liberar Semana (Profissional + Procedimento)
            </ion-button>
          </div>
        </div>

        <!-- Indicador de altera√ß√µes pendentes -->
        <div *ngIf="hasUnsavedChanges" class="pending-changes">
          <p>‚ö†Ô∏è {{ pendingChanges.length }} altera√ß√£o(√µes) pendente(s)</p>
          <div class="save-actions">
            <ion-button expand="block" color="success" (click)="salvarAlteracoes()">
              üíæ Salvar Altera√ß√µes
            </ion-button>
            <ion-button expand="block" fill="outline" color="medium" (click)="descartarAlteracoes()">
              ‚Ü©Ô∏è Descartar
            </ion-button>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Grade de Hor√°rios -->
    <ion-card class="schedule-card">
      <ion-card-header>
        <ion-card-title>Hor√°rios - {{ selectedDate }}</ion-card-title>
        <p>Clique nos hor√°rios para liberar/bloquear</p>
      </ion-card-header>
      <ion-card-content>
        <div class="time-grid">
          <div *ngFor="let slot of timeSlots"
               class="time-slot"
               [class.available]="slot.status === 'livre'"
               [class.blocked]="slot.status === 'bloqueado'"
               [class.booked]="slot.status === 'ocupado'"
               [class.has-changes]="slot.hasChanges"
               (click)="toggleTimeSlot(slot)">
            <div class="time">{{ slot.time }}</div>
            <div class="status">{{ getStatusLabel(slot.status) }}</div>
            <div *ngIf="slot.cliente" class="client">{{ slot.cliente }}</div>
            <div *ngIf="slot.hasChanges" class="change-indicator">‚úèÔ∏è</div>
          </div>
        </div>

        <div class="legend">
          <div class="legend-item">
            <span class="legend-dot available"></span>
            <span>Livre</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot blocked"></span>
            <span>Bloqueado</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot booked"></span>
            <span>Ocupado</span>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Agendamentos do Dia -->
    <ion-card *ngIf="agendamentosData.length > 0">
      <ion-card-header>
        <ion-card-title>Agendamentos de {{ selectedDate }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item *ngFor="let ag of agendamentosData">
            <ion-label>
              <h3>{{ ag.hora }} - {{ ag.cliente_nome || 'Cliente' }}</h3>
              <p>{{ ag.procedimento_nome || 'Procedimento' }}</p>
              <p class="status-badge" [class]="'status-' + ag.status">{{ ag.status | titlecase }}</p>
              <p *ngIf="ag.observacoes"><small>{{ ag.observacoes }}</small></p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

  </div>
</ion-content>
